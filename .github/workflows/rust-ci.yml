name: Rust CI

on:
  push:
    branches:
      - master
      - main
      - llvm18
  pull_request:
    branches:
      - '**'

jobs:
  format:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt
    - name: Check code formatting
      run: cargo fmt -- --check

  machete:
    runs-on: ubuntu-latest
    steps:
    - name: Setup sccache
      if: github.event_name != 'release' && github.event_name != 'workflow_dispatch'
      uses: mozilla-actions/sccache-action@v0.0.9

    - name: Configure sccache
      if: github.event_name != 'release' && github.event_name != 'workflow_dispatch'
      run: |
        echo "SCCACHE_GHA_ENABLED=true" >> "$GITHUB_ENV"
        echo "RUSTC_WRAPPER=sccache" >> "$GITHUB_ENV"

    - uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Install cargo-machete
      run: cargo install cargo-machete

    - name: Run cargo machete
      run: cargo machete

  # Detect available LLVM versions from GitHub releases
  detect-llvm-versions:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
    - name: Query LLVM releases and generate matrix
      id: set-matrix
      run: |
        # Query LLVM GitHub releases for available major versions
        # We support LLVM 18, 19, 20, 21
        SUPPORTED_VERSIONS="18 19 20 21"

        # Check which versions are available via apt.llvm.org
        AVAILABLE_VERSIONS=""
        for ver in $SUPPORTED_VERSIONS; do
          # Check if the version is available (apt.llvm.org hosts versions 11+)
          if curl -s --head "https://apt.llvm.org/llvm.sh" | head -1 | grep -q "200"; then
            AVAILABLE_VERSIONS="$AVAILABLE_VERSIONS $ver"
          fi
        done

        # For now, use a static list of versions we know work
        # apt.llvm.org supports versions 11-21
        # Generate JSON matrix
        MATRIX='{"include":['

        # LLVM 18.1 - Ubuntu Noble system package
        MATRIX="${MATRIX}{\"llvm_version\":\"18\",\"llvm_env_var\":\"LLVM_SYS_181_PREFIX\",\"cargo_features\":\"--no-default-features --features llvm18\"}"

        # LLVM 19.1
        MATRIX="${MATRIX},{\"llvm_version\":\"19\",\"llvm_env_var\":\"LLVM_SYS_191_PREFIX\",\"cargo_features\":\"--no-default-features --features llvm19\"}"

        # LLVM 20.1
        MATRIX="${MATRIX},{\"llvm_version\":\"20\",\"llvm_env_var\":\"LLVM_SYS_201_PREFIX\",\"cargo_features\":\"--no-default-features --features llvm20\"}"

        # LLVM 21.1
        MATRIX="${MATRIX},{\"llvm_version\":\"21\",\"llvm_env_var\":\"LLVM_SYS_211_PREFIX\",\"cargo_features\":\"--no-default-features --features llvm21\"}"

        MATRIX="${MATRIX}]}"

        echo "Generated matrix: $MATRIX"
        echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"

  ubuntu-build-test:
    strategy:
      fail-fast: false
      matrix:
        include:
          # LLVM 18 - Ubuntu Noble system package
          - llvm_version: "18"
            llvm_env_var: "LLVM_SYS_181_PREFIX"
            cargo_features: "--no-default-features --features llvm18"
          # LLVM 21 - Latest from apt.llvm.org
          - llvm_version: "21"
            llvm_env_var: "LLVM_SYS_211_PREFIX"
            cargo_features: "--no-default-features --features llvm21"
    runs-on: ubuntu-latest
    needs: [format, machete]
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: clippy
        targets: x86_64-pc-windows-gnu

    - name: Setup sccache
      if: github.event_name != 'release' && github.event_name != 'workflow_dispatch'
      uses: mozilla-actions/sccache-action@v0.0.9

    - name: Configure sccache
      if: github.event_name != 'release' && github.event_name != 'workflow_dispatch'
      run: |
        echo "SCCACHE_GHA_ENABLED=true" >> "$GITHUB_ENV"
        echo "RUSTC_WRAPPER=sccache" >> "$GITHUB_ENV"

    - name: "Cache cargo"
      id: cache-cargo
      uses: "actions/cache@v4"
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        save-always: true
        key: ${{ runner.os }}-${{runner.arch}}-llvm${{ matrix.llvm_version }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: ${{ runner.os }}-${{runner.arch}}-llvm${{ matrix.llvm_version }}-cargo-

    - name: Install LLVM ${{ matrix.llvm_version }} and Windows cross-compilation tools
      run: |
        wget https://apt.llvm.org/llvm.sh
        chmod +x llvm.sh
        sudo ./llvm.sh ${{ matrix.llvm_version }}
        sudo apt-get install -y llvm-${{ matrix.llvm_version }} llvm-${{ matrix.llvm_version }}-dev libclang-${{ matrix.llvm_version }}-dev

        # Install llvm-lib for Windows cross-compilation
        sudo apt-get install -y mingw-w64

        # Create symlink for llvm-lib
        sudo ln -sf /usr/bin/llvm-ar-${{ matrix.llvm_version }} /usr/local/bin/llvm-lib

        # Verify installation
        which llvm-lib
        llvm-lib --version

    - name: Set LLVM environment variables
      run: |
        # See https://gitlab.com/taricorp/llvm-sys.rs/#llvm-compatibility for details
        # Set LLVM prefix for llvm-sys crate
        echo "${{ matrix.llvm_env_var }}=/usr/lib/llvm-${{ matrix.llvm_version }}" >> "$GITHUB_ENV"

        # llvm-sys needs llvm-config to be findable - create symlink in the LLVM bin dir if not already present
        sudo mkdir -p /usr/lib/llvm-${{ matrix.llvm_version }}/bin
        sudo ln -sf /usr/bin/llvm-config-${{ matrix.llvm_version }} /usr/lib/llvm-${{ matrix.llvm_version }}/bin/llvm-config || true

        {
          echo "CLANG_PATH=/usr/lib/llvm-${{ matrix.llvm_version }}/bin/clang"
          echo "PATH=/usr/lib/llvm-${{ matrix.llvm_version }}/bin:$PATH"
          echo "RUST_BACKTRACE=1"
        } >> "$GITHUB_ENV"

        # Verify llvm-config is accessible
        /usr/lib/llvm-${{ matrix.llvm_version }}/bin/llvm-config --version

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential

    - name: Build
      run: |
        # Build specific packages to avoid workspace feature unification issues
        # that cause multiple llvm-sys versions to be compiled
        cargo build --release --package openvaf-driver ${{ matrix.cargo_features }}
        cargo build --release --package openvaf ${{ matrix.cargo_features }}
        cargo build --release --package osdi ${{ matrix.cargo_features }}
        cargo build --release --package mir_llvm ${{ matrix.cargo_features }}

    - name: Show sccache stats
      if: github.event_name != 'release' && github.event_name != 'workflow_dispatch'
      shell: bash
      run: ${SCCACHE_PATH} --show-stats
    # someone has to fix the errors
    # - name: Run Clippy
    #   run: cargo clippy -- -D warnings

    - name: Run tests
      run: |
        # Run tests for specific packages to avoid workspace feature unification issues
        cargo test --release --package openvaf-driver ${{ matrix.cargo_features }}
        cargo test --release --package openvaf ${{ matrix.cargo_features }}
        cargo test --release --package osdi ${{ matrix.cargo_features }}
        cargo test --release --package mir_llvm ${{ matrix.cargo_features }}

    - name: Run integration tests
      run: cargo test --release --package openvaf --test integration ${{ matrix.cargo_features }}

  msys2-build-test:
    strategy:
      fail-fast: false
      matrix:
        sys: [MINGW64, UCRT64]
    runs-on: windows-latest
    needs: [format, machete]
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: ${{ matrix.sys }}
        update: true
        install: base-devel git ca-certificates
        pacboy: >-
          openssl:p
          clang:p
          llvm:p
          rust:p
          cc:p
          python:p
          sccache:p
    #- name: Configure Git to use Schannel
    #  shell: msys2 {0}
    #  run: git config --global http.sslBackend schannel

    - name: Configure Cargo to use CLI Git
      shell: bash
      run: |
        mkdir -p .cargo
        echo '[net]' > .cargo/config.toml
        echo 'git-fetch-with-cli = true' >> .cargo/config.toml

    - name: Cache sccache
      uses: actions/cache@v4
      with:
        path: ~/.cache/sccache
        key: ${{ runner.os }}-${{ runner.arch }}}-sccache-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-${{ runner.arch }}-sccache-

    - name: Locate and configure sccache
      shell: msys2 {0}
      run: |
        # export SCCACHE_PATH=$(which sccache)
        # echo "SCCACHE_GHA_ENABLED=true" >> "$GITHUB_ENV"
        echo "RUSTC_WRAPPER=${SCCACHE_PATH}" >> "$GITHUB_ENV"

    - name: "Cache cargo"
      id: cache-cargo
      uses: "actions/cache@v4"
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        save-always: true
        key: ${{ runner.os }}-${{ runner.arch }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: ${{ runner.os }}-${{ runner.arch }}-cargo-

    - name: Run cargo
      shell: msys2 {0}
      run: cargo build --release --features llvm21
    #- name: Show sccache stats
    #  if: github.event_name != 'release' && github.event_name != 'workflow_dispatch'
    #  shell: msys2 {0}
    #  run: $SCCACHE_PATH --show-stats

    - name: Run tests
      shell: msys2 {0}
      run: cargo test --release --features llvm21

  macos-build-test:
    strategy:
      fail-fast: false
      matrix:
        # Use default Homebrew LLVM (latest) on all macOS runners
        image: [macos-15-intel, macos-15, macos-14]

    runs-on: ${{ matrix.image }}
    needs: [format, machete]
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies with Homebrew
      uses: tecolicom/actions-use-homebrew-tools@v1
      with:
        tools: pkg-config sccache llvm
        cache: yes

    - name: Set LLVM environment variables
      run: |
        echo "$(brew --prefix llvm)/bin" >> "$GITHUB_PATH"
        {
          echo "LLVM_SYS_211_PREFIX=$(brew --prefix llvm)"
          echo "RUST_BACKTRACE=1"
          echo "RUN_DEV_TESTS=1"
        } >> "$GITHUB_ENV"

    - name: sccache setup
      run: |
        # echo "SCCACHE_GHA_ENABLED=true" >> "$GITHUB_ENV"
        echo "RUSTC_WRAPPER=$(which sccache)" >> "$GITHUB_ENV"

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: "Cache cargo"
      id: cache-cargo
      uses: "actions/cache@v4"
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        save-always: true
        key: ${{ runner.os }}-${{runner.arch}}-llvm-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: ${{ runner.os }}-${{runner.arch}}-llvm-cargo-

    - name: Build
      run: cargo build --release --features llvm21

    - name: Run tests
      run: cargo test --release --features llvm21

    - name: Run integration tests
      run: cargo test --release --features llvm21 --test integration
