name: Deploy Visualizations

on:
  push:
    branches:
      - master
      - main
    paths:
      - 'openvaf/openvaf-viz/**'
      - 'integration_tests/**'
      - '.github/workflows/build-viz.yml'
      - '.github/workflows/deploy-viz.yml'
  workflow_dispatch:

# Allow only one deployment at a time
concurrency:
  group: pages-deploy
  cancel-in-progress: true

jobs:
  build-viz:
    uses: ./.github/workflows/build-viz.yml

  deploy:
    runs-on: ubuntu-latest
    needs: build-viz
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download viz artifact
        uses: actions/download-artifact@v4
        with:
          name: viz
          path: viz-output

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Check for existing gh-pages content
        id: check-pages
        run: |
          # Check if gh-pages branch exists and has pr-preview directory
          if git ls-remote --heads origin gh-pages | grep -q gh-pages; then
            git fetch origin gh-pages:gh-pages || true
            if git show gh-pages:pr-preview 2>/dev/null; then
              echo "has-previews=true" >> "$GITHUB_OUTPUT"
            else
              echo "has-previews=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "has-previews=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Preserve PR previews
        if: steps.check-pages.outputs.has-previews == 'true'
        run: |
          # Copy existing pr-preview directory to preserve PR previews
          git worktree add gh-pages-checkout gh-pages
          if [ -d "gh-pages-checkout/pr-preview" ]; then
            cp -r gh-pages-checkout/pr-preview viz-output/
            echo "Preserved existing PR previews"
          fi
          git worktree remove gh-pages-checkout --force

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: viz-output

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
