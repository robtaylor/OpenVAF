name: Build Visualizations
on:
  workflow_call:

jobs:
  build-viz:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Configure sccache
        run: |
          echo "SCCACHE_GHA_ENABLED=true" >> "$GITHUB_ENV"
          echo "RUSTC_WRAPPER=sccache" >> "$GITHUB_ENV"

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-${{ runner.arch }}-viz-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-${{ runner.arch }}-viz-cargo-

      - name: Build openvaf-viz
        run: cargo build --release --package openvaf-viz --no-default-features

      - name: Create output directory
        run: mkdir -p viz-output

      - name: Generate visualizations for all models
        run: |
          set -e

          # Find all integration test .va files
          for va_file in integration_tests/*/*.va; do
            if [ -f "$va_file" ]; then
              model_dir=$(dirname "$va_file")
              model_name=$(basename "$model_dir")
              va_name=$(basename "$va_file" .va)

              echo "Processing: $va_file"

              # Create output directory for this model
              mkdir -p "viz-output/$model_name"

              # Generate visualization (may have multiple modules per file)
              ./target/release/openvaf-viz "$va_file" \
                --output "viz-output/$model_name/${va_name}.html" \
                --format html \
                2>&1 || echo "Warning: Failed to process $va_file"
            fi
          done

          echo "Visualization generation complete"

      - name: Generate index page
        run: |
          cat > viz-output/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>OpenVAF IR Visualizations</title>
            <style>
              :root {
                --bg-primary: #1a1a2e;
                --bg-secondary: #16213e;
                --bg-card: #0f3460;
                --text-primary: #eaeaea;
                --text-secondary: #a0a0a0;
                --accent: #e94560;
                --accent-hover: #ff6b6b;
                --border: #2a2a4a;
              }

              * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
              }

              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
                background: var(--bg-primary);
                color: var(--text-primary);
                line-height: 1.6;
                min-height: 100vh;
              }

              .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 2rem;
              }

              header {
                text-align: center;
                margin-bottom: 3rem;
                padding: 2rem;
                background: var(--bg-secondary);
                border-radius: 12px;
                border: 1px solid var(--border);
              }

              h1 {
                font-size: 2.5rem;
                margin-bottom: 0.5rem;
                background: linear-gradient(135deg, var(--accent), #ff9a9e);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
              }

              header p {
                color: var(--text-secondary);
                font-size: 1.1rem;
              }

              .models-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 1.5rem;
              }

              .model-card {
                background: var(--bg-card);
                border-radius: 10px;
                padding: 1.5rem;
                border: 1px solid var(--border);
                transition: transform 0.2s, box-shadow 0.2s;
              }

              .model-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 8px 25px rgba(233, 69, 96, 0.2);
              }

              .model-card h3 {
                color: var(--accent);
                margin-bottom: 0.75rem;
                font-size: 1.25rem;
              }

              .model-card ul {
                list-style: none;
              }

              .model-card li {
                margin: 0.5rem 0;
              }

              .model-card a {
                color: var(--text-primary);
                text-decoration: none;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.5rem;
                border-radius: 6px;
                transition: background 0.2s;
              }

              .model-card a:hover {
                background: rgba(233, 69, 96, 0.1);
                color: var(--accent-hover);
              }

              .model-card a::before {
                content: 'â†’';
                color: var(--accent);
              }

              footer {
                text-align: center;
                margin-top: 3rem;
                padding: 1.5rem;
                color: var(--text-secondary);
                font-size: 0.9rem;
              }

              footer a {
                color: var(--accent);
                text-decoration: none;
              }

              footer a:hover {
                text-decoration: underline;
              }

              .stats {
                display: flex;
                justify-content: center;
                gap: 2rem;
                margin-top: 1rem;
              }

              .stat {
                text-align: center;
              }

              .stat-value {
                font-size: 2rem;
                font-weight: bold;
                color: var(--accent);
              }

              .stat-label {
                font-size: 0.9rem;
                color: var(--text-secondary);
              }
            </style>
          </head>
          <body>
            <div class="container">
              <header>
                <h1>OpenVAF IR Visualizations</h1>
                <p>Interactive visualizations of Verilog-A compact models</p>
                <div class="stats">
                  <div class="stat">
                    <div class="stat-value" id="model-count">0</div>
                    <div class="stat-label">Models</div>
                  </div>
                  <div class="stat">
                    <div class="stat-value" id="viz-count">0</div>
                    <div class="stat-label">Visualizations</div>
                  </div>
                </div>
              </header>

              <div class="models-grid" id="models-grid">
                <!-- Generated by script below -->
              </div>

              <footer>
                <p>Generated by <a href="https://github.com/pascalkuthe/OpenVAF">OpenVAF</a> openvaf-viz</p>
              </footer>
            </div>

            <script>
              // Model data will be injected here
              const models = MODEL_DATA_PLACEHOLDER;

              const grid = document.getElementById('models-grid');
              let totalViz = 0;

              Object.keys(models).sort().forEach(modelName => {
                const files = models[modelName];
                totalViz += files.length;

                const card = document.createElement('div');
                card.className = 'model-card';
                card.innerHTML = `
                  <h3>${modelName}</h3>
                  <ul>
                    ${files.map(f => `<li><a href="${modelName}/${f}.html">${f}</a></li>`).join('')}
                  </ul>
                `;
                grid.appendChild(card);
              });

              document.getElementById('model-count').textContent = Object.keys(models).length;
              document.getElementById('viz-count').textContent = totalViz;
            </script>
          </body>
          </html>
          EOF

          # Generate model data JSON
          MODEL_DATA=$(python3 << 'PYTHON'
          import os
          import json

          models = {}
          viz_dir = 'viz-output'

          for model_dir in sorted(os.listdir(viz_dir)):
            model_path = os.path.join(viz_dir, model_dir)
            if os.path.isdir(model_path) and model_dir != '.git':
              files = []
              for f in sorted(os.listdir(model_path)):
                if f.endswith('.html'):
                  files.append(f[:-5])  # Remove .html extension
              if files:
                models[model_dir] = files

          print(json.dumps(models))
          PYTHON
          )

          # Inject model data into index.html
          sed -i "s|MODEL_DATA_PLACEHOLDER|$MODEL_DATA|g" viz-output/index.html

          echo "Index page generated"

      - name: Upload visualization artifact
        uses: actions/upload-artifact@v4
        with:
          name: viz
          path: viz-output
          retention-days: 30
