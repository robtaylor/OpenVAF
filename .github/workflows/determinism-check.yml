name: Determinism Check

on:
  workflow_dispatch:
    inputs:
      runs:
        description: 'Number of test runs per architecture'
        required: false
        default: '5'

jobs:
  determinism-check:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            llvm_setup: apt
          - os: macos-15
            llvm_setup: brew
          - os: macos-15-intel
            llvm_setup: brew
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      # Linux LLVM setup
      - name: Install LLVM 18 (Linux)
        if: matrix.llvm_setup == 'apt'
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 18
          sudo apt-get install -y llvm-18 llvm-18-dev libclang-18-dev
          sudo apt-get install -y build-essential

      - name: Set LLVM environment variables (Linux)
        if: matrix.llvm_setup == 'apt'
        run: |
          echo "LLVM_SYS_181_PREFIX=/usr/lib/llvm-18" >> $GITHUB_ENV
          echo "CLANG_PATH=/usr/lib/llvm-18/bin/clang" >> $GITHUB_ENV
          echo "PATH=/usr/lib/llvm-18/bin:$PATH" >> $GITHUB_ENV

      # macOS LLVM setup
      - name: Install dependencies with Homebrew (macOS)
        if: matrix.llvm_setup == 'brew'
        uses: tecolicom/actions-use-homebrew-tools@v1
        with:
          tools: pkg-config llvm@18
          cache: yes

      - name: Set LLVM environment variables (macOS)
        if: matrix.llvm_setup == 'brew'
        run: |
          echo "$(brew --prefix llvm@18)/bin" >> $GITHUB_PATH
          echo "LLVM_SYS_181_PREFIX=$(brew --prefix llvm@18)" >> $GITHUB_ENV

      # Common environment setup
      - name: Set common environment variables
        run: |
          echo "RUN_DEV_TESTS=1" >> $GITHUB_ENV
          echo "RUST_BACKTRACE=1" >> $GITHUB_ENV

      # Build once
      - name: Build
        run: cargo build --release

      # Run integration tests multiple times using our script
      - name: Capture snapshots from multiple runs
        run: bash scripts/determinism-capture.sh ${{ github.event.inputs.runs || '5' }} snapshots

      # Compare snapshots using our script
      - name: Compare snapshots between runs
        run: bash scripts/determinism-compare.sh snapshots

      # Upload all snapshots as artifact (always, even on failure)
      - name: Upload snapshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: snapshots-${{ matrix.os }}
          path: snapshots/
          retention-days: 7
